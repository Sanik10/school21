# Сети в Linux

## Краткое описание

Учебный практический проект по базовой сетевой администрции в Linux на виртуальных машинах. В рамках работы на Ubuntu 20.04 Server настраиваются IP‑адреса и маршрутизация, измеряется скорость соединения, конфигурируется файрвол на `iptables`, реализуются статическая и динамическая маршрутизация (DHCP), NAT (SNAT/DNAT) и SSH‑туннели. Все шаги задокументированы в отчёте в формате Markdown.

---

## Цели проекта

- Отработать базовые навыки работы с сетями в Linux:
  - адресация, маски, маршруты;
  - настройка интерфейсов и шлюзов;
  - диагностика и отладка сетевых проблем.
- Освоить основные сетевые утилиты и их типичные сценарии применения.
- На практике настроить:
  - статическую маршрутизацию между несколькими хостами и сетями;
  - DHCP‑сервера и клиентов;
  - фильтрацию трафика и простые правила файрвола на `iptables`;
  - NAT для выхода во внешнюю сеть и проброса портов;
  - SSH‑туннели (local/remote port forwarding) для доступа в закрытые сети.

---

## Основные разделы и выполненные задачи

### Part 1. Инструмент `ipcalc`: адресация и маски

- Расчёт:
  - адреса сети по заданному адресу и префиксу;
  - преобразование масок между:
    - обычной (точечной десятичной),
    - префиксной (`/N`),
    - двоичной;
  - определение минимального/максимального IP‑адресов хоста в сети при разных масках.
- Анализ особенностей `localhost`:
  - какие адреса считаются loopback (127.0.0.0/8),
  - с каких IP можно обратиться к сервису, слушающему `127.0.0.1`.
- Классификация IP‑адресов:
  - разделение на публичные/частные;
  - проверка вхождения адресов в диапазоны `10.0.0.0/8`, `172.16.0.0/12`, `192.168.0.0/16`.
- Выбор возможных адресов шлюза для заданной подсети.

### Part 2. Статическая маршрутизация между двумя машинами

- Подняты две виртуальные машины: `ws1` и `ws2`.
- Настройка сетевых интерфейсов через `netplan`:
  - `ws1`: `192.168.100.10/16`;
  - `ws2`: `172.24.116.8/12`.
- Добавление статических маршрутов:
  - временно, через `ip route add`;
  - постоянно, через `netplan` (редактирование `/etc/netplan/00-installer-config.yaml`).
- Проверка связности:
  - просмотр интерфейсов `ip a`;
  - проверка таблицы маршрутизации `ip r`;
  - проверка пинга между машинами.

### Part 3. Утилита `iperf3`: измерение скорости соединения

- Перевод единиц скорости (Mbps, MB/s, Kbps, Gbps).
- Развёртывание `iperf3`:
  - запуск сервера на одной машине;
  - запуск клиента на другой.
- Измерение пропускной способности канала между `ws1` и `ws2` и анализ полученных значений.

### Part 4. Сетевой экран на `iptables`

- Создание простого скрипта файрвола `/etc/firewall.sh` на `ws1` и `ws2`:
  - очистка таблиц `filter` и `nat`;
  - добавление правил в заданном порядке.
- Практика двух стратегий:
  - **Сначала deny, потом allow** (ws1);
  - **Сначала allow, потом deny** (ws2).
- Настройка:
  - открытие портов 22 (SSH) и 80 (HTTP);
  - запрет и последующее разрешение ICMP echo reply (управление возможностью «пинговаться»).
- Запуск скриптов, проверка:
  - изменения правил `iptables -L -v -n`;
  - работа/блокировка `ping`.
- Использование `ping` и `nmap`:
  - демонстрация ситуации, когда хост не отвечает на ICMP, но порты открыты, и `nmap` показывает `Host is up`.

### Part 5. Статическая маршрутизация сети

- Построение топологии:
  - 3 рабочие станции: `ws11`, `ws21`, `ws22`;
  - 2 роутера: `r1`, `r2`.
- Настройка IP‑адресов на всех машинах через `netplan`.
- Включение IP‑переадресации:
  - временно через `sysctl -w net.ipv4.ip_forward=1`;
  - постоянно через `/etc/sysctl.conf`.
- Настройка маршрута по умолчанию на рабочих станциях:
  - добавление `default via` в конфигурации `netplan`;
  - проверка через `ip r`.
- Добавление статических маршрутов на `r1` и `r2`:
  - добавление блоков `routes:` для нужных сетей;
  - проверка таблиц маршрутизации на обоих роутерах.
- Анализ выбора маршрута:
  - использование `ip r list <сеть>` и `ip r list 0.0.0.0/0`;
  - объяснение, почему выбирается более специфичный маршрут, даже если есть маршрут по умолчанию.
- Изучение пути до узла:
  - запуск `traceroute` с рабочей станции;
  - параллельная запись трафика на роутере через `tcpdump`;
  - разбор принципа работы `traceroute` (TTL, ICMP Time Exceeded).
- Использование ICMP при маршрутизации:
  - перехват ICMP‑пакетов `tcpdump -n -i eth0 icmp`;
  - пинг несуществующего адреса и анализ ICMP‑ответов.

### Part 6. Динамическая настройка IP с помощью DHCP

- Настройка DHCP‑сервера на `r2` (`/etc/dhcp/dhcpd.conf`):
  - объявление подсетей;
  - выдача адресов из диапазона `range`;
  - указание шлюза (`option routers`) и DNS‑сервера (`option domain-name-servers`).
- Настройка DNS‑резолвера через `/etc/resolv.conf` (`nameserver 8.8.8.8`).
- Перезапуск службы DHCP (`systemctl restart isc-dhcp-server`), перезагрузка рабочих станций, проверка:
  - полученного IP‑адреса (`ip a`);
  - доступности по сети (ping между ws21 и ws22).
- Назначение MAC‑адреса на `ws11` в `netplan` и включение `dhcp4: true`.
- Настройка DHCP на `r1` с жёсткой привязкой IP к MAC (static lease).
- Обновление адреса на клиенте (`dhclient` или эквивалент) и анализ:
  - адреса до и после;
  - опций DHCP, задействованных в процессе (DISCOVER/OFFER/REQUEST/ACK, lease time и др.).

### Part 7. NAT (SNAT и DNAT)

- Настройка Apache на `ws22` и `r1`:
  - изменение `Listen` в `/etc/apache2/ports.conf` на `0.0.0.0:80` (общедоступный сервер);
  - запуск веб‑сервера `service apache2 start`.
- Конфигурация файрвола на `r2` (аналогично Part 4):
  - очистка таблиц `filter` и `nat`;
  - политика `DROP` для `FORWARD` (отбрасывать маршрутизируемые пакеты);
  - поэтапное разрешение ICMP‑трафика для проверки пинга.
- Включение:
  - **SNAT/маскарадинга** для внутренней сети за `r2` (например, `10.20.0.0/…`) — выход во внешнюю сеть через один внешний IP;
  - **DNAT** на порт `8080` `r2` для проброса HTTP‑сервера с `ws22` наружу.
- Проверка:
  - TCP‑соединения до Apache на `r1` с `ws22` (проверка SNAT) через `telnet [адрес r1] 80`;
  - TCP‑соединения до Apache на `ws22` с `r1` по адресу `r2:8080` (проверка DNAT).

### Part 8. SSH Tunnels (дополнительно)

- Запуск файрвола на `r2` с правилами из Part 7.
- Настройка Apache на `ws22` только на `localhost` (`Listen localhost:80`).
- Использование:
  - **Local TCP forwarding**:
    - создание локального туннеля с `ws21` к `ws22` через SSH;
    - доступ к веб‑серверу `ws22` с `ws21` через `telnet 127.0.0.1 <локальный_порт>`.
  - **Remote TCP forwarding**:
    - создание удалённого туннеля с `ws11` на `ws22`;
    - доступ к веб‑серверу `ws22` с `ws11` через `telnet 127.0.0.1 <удалённый_порт>`.
- Практика работы с `ssh -L` и `ssh -R` в условиях ограниченного сетевого доступа.

---

## Используемые технологии и инструменты

**ОС и окружение**

- Ubuntu 20.04 Server LTS (все виртуальные машины)
- VirtualBox / другой гипервизор для создания VM и настройки сетей (Internal Network и др.)

**Ключевые утилиты**

- Адресация и маршруты:  
  `ipcalc`, `ip`, `netplan`, `netstat`, `route`
- Диагностика:  
  `ping`, `traceroute`, `tcpdump`, `nmap`
- Производительность:  
  `iperf3`
- Файрвол и NAT:  
  `iptables`, `sysctl`
- Службы:  
  `systemctl`, `service`
- DHCP:  
  `dhclient`, `isc-dhcp-server`
- Веб‑сервер и TCP‑клиенты:  
  `apache2`, `telnet`
- SSH и туннели:  
  `ssh` (опции `-L`, `-R`)

---

## Структура репозитория

Примерная структура (может незначительно отличаться):

```text
.
├── src/
│   └── report.md          # Основной отчёт по заданию (выполненные части и скриншоты)
├── misc/
│   └── images/            # Диаграммы и вспомогательные изображения (топологии, иллюстрации)
├── README.md              # Этот файл
└── ...
```

- В отчёте выделены все части задания заголовками второго уровня.
- Для каждой части приведён список действий, команд и скриншотов с кратким описанием того, что на них показано.
